# fino_core プロジェクトの設計パターン適用判定

## 現在のプロジェクト構造

### 現状の構成

```
fino_core/
├── _model/          # ドメインモデル層
│   ├── period/      # エンティティ（Period）
│   ├── storage/     # ポート（StoragePort）とConfig
│   └── target/      # ポート（TargetPort）とConfig
├── _factory/        # ファクトリー層
│   ├── storage/     # StoragePortの実装（LocalStorage, S3Storage）
│   └── target/      # TargetPortの実装（EdinetAdapter）
└── collector/       # ユースケース層（？）
```

### 現在採用されているパターン

- **ポート&アダプターパターン**: `_model`でポート（インターフェース）を定義、`_factory`でアダプター（実装）を提供
- **ファクトリーパターン**: `create_storage()`, `create_target()`で実装を生成
- **依存性逆転の原則**: ドメインモデルがインターフェースを定義し、実装がそれに依存

## 提供された設計パターンとの比較

### 提供された設計パターン

- **クリーンアーキテクチャ + ヘキサゴナルアーキテクチャ**
- **層構造**:
  - ドメイン層 (`pkg/domain/`): entity, repository, service, value, errors
  - ユースケース層 (`pkg/usecase/`): interactor, port, input/output DTO
  - インターフェース層 (`pkg/interface/`): controller, gateway
  - インフラストラクチャ層 (`pkg/infrastructure/`): AWS 実装、ミドルウェア

## 判定結果

### ✅ **参考にするべき: 部分的に適用推奨**

#### 適用すべき点

1. **ユースケース層の明確化**

   - 現状: `collector/`がユースケース層として機能しているが、構造が不明確
   - 推奨: `usecase/`ディレクトリを作成し、`interactor/`でビジネスロジックを実装
   - 理由: ビジネスロジックと外部インターフェースの分離が明確になる

2. **エラーハンドリングの整理**

   - 現状: `_model/target/edinet/exception.py`にエラーが定義されている
   - 推奨: ドメインエラーを`_model/errors/`に集約し、インフラエラーと分離
   - 理由: エラーの分類と配置が明確になる

3. **依存性注入（DI）の導入検討**
   - 現状: ファクトリーパターンで実装を生成
   - 推奨: Python の DI コンテナ（dependency-injector 等）の導入を検討
   - 理由: テスト容易性と拡張性の向上

#### 現状維持で良い点

1. **ポート&アダプターパターン**

   - ✅ 既に適切に実装されている
   - `_model`でポート、`_factory`でアダプターという分離は適切

2. **ドメインモデルの分離**

   - ✅ `_model`でドメインエンティティとポートが適切に定義されている
   - 外部依存（requests 等）がドメインモデルに混入していない

3. **ファクトリーパターン**
   - ✅ 実装の生成ロジックが適切に分離されている

#### 適用しない方が良い点

1. **過度な層の分割**

   - 現状の`_model`と`_factory`の分離は適切
   - 提供パターンの`interface/gateway`と`infrastructure`の分離は、このプロジェクト規模では過剰な可能性

2. **命名規則の変更**
   - 現状の`_model`、`_factory`という命名は明確で理解しやすい
   - 提供パターンの`domain`、`usecase`への変更は必須ではない

## 推奨される改善事項

### 優先度: 高

1. **ユースケース層の構造化**

   ```
   collector/ または usecase/
   ├── interactor/
   │   └── collect_interactor.py
   ├── port/
   │   └── collector_port.py
   └── dto/
       ├── input.py
       └── output.py
   ```

2. **エラーハンドリングの整理**
   ```
   _model/
   └── errors/
       ├── domain_error.py
       └── target/
           └── edinet_error.py
   ```

### 優先度: 中

3. **依存性注入の検討**

   - 現状のファクトリーパターンで十分な場合も多い
   - テスト容易性を向上させたい場合に検討

4. **リポジトリパターンの検討**
   - データ永続化が必要になった場合に検討
   - 現状は外部 API 呼び出しが主なので、現時点では不要

### 優先度: 低

5. **命名規則の統一**
   - 現状の命名で問題なければ維持
   - チーム内で統一されていれば変更不要

## 総合評価

**適切性: 7/10（部分的に適用推奨）**

### 理由

✅ **良い点**

- ポート&アダプターパターンが適切に実装されている
- ドメインモデルと実装の分離が明確
- 外部依存がドメインモデルに混入していない

⚠️ **改善点**

- ユースケース層の構造が不明確
- エラーハンドリングの配置が散在している可能性
- ビジネスロジックの責務が不明確

### 結論

提供された設計パターンは**部分的に参考にするべき**です。特に：

- ユースケース層の明確化
- エラーハンドリングの整理
- 依存性注入の検討

これらを適用することで、保守性と拡張性が向上します。ただし、現状のポート&アダプターパターンとファクトリーパターンは適切に実装されているため、過度な変更は不要です。
